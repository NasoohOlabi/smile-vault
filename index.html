<!DOCTYPE html>
<html
	lang="en"
	class="dark:bg-gray-900 dark:text-gray-100 bg-gray-50 text-gray-900"
>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Refined Store</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<!-- Swapping Inter for a more creative, elegant font combination -->
		<link
			href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Merriweather:wght@300;400;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			/* Playfair Display for headings, Merriweather for body text */
			body {
				font-family: Arial, Helvetica, sans-serif;
			}
			h1,
			h2,
			h3 {
				font-family: Arial, Helvetica, sans-serif;
			}
			/* Remove default scrollbar from the tabs container */
			#tabNav::-webkit-scrollbar {
				display: none;
			}
			#tabNav {
				-ms-overflow-style: none; /* IE and Edge */
				scrollbar-width: none; /* Firefox */
			}
			/* Active tab styling */
			.tab-active {
				color: #57534e !important; /* stone-600 */
				border-bottom-color: #57534e !important; /* stone-600 */
			}
			.dark .tab-active {
				color: #d6d3d1 !important; /* stone-300 */
				border-bottom-color: #d6d3d1 !important; /* stone-300 */
			}
			@media (prefers-color-scheme: dark) {
				:root {
					color-scheme: dark;
				}
			}
			@media (prefers-color-scheme: light) {
				:root {
					color-scheme: light;
				}
			}
		</style>
	</head>
	<body
		class="min-h-screen transition-colors duration-300 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100"
	>
		<!-- HEADER: Now sticky at the top with high Z-index -->
		<header
			class="sticky top-0 z-30 p-6 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 shadow-lg"
		>
			<div class="container mx-auto flex justify-between items-center">
				<h1 class="text-4xl font-extrabold tracking-wider">
					DAMA<span
						class="text-stone-600 dark:text-stone-400 pl-2 text-3xl"
						>OBSRV</span
					>
				</h1>
				<button
					class="px-5 py-2 text-sm font-semibold tracking-wide rounded-full bg-stone-600 text-white hover:bg-stone-700 dark:bg-stone-400 dark:text-gray-900 dark:hover:bg-stone-300 transition shadow-md"
					onclick="showOrderSummary()"
				>
					ORDER (<span id="cartCount">0</span>)
				</button>
			</div>
		</header>

		<!-- TAB BAR: Made sticky, top position set dynamically for perfect alignment -->
		<div
			id="sticky-tabs-wrapper"
			class="sticky z-20 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-800 py-2"
		>
			<nav
				id="tabNav"
				class="container mx-auto px-4 md:px-8 flex gap-4 overflow-x-scroll whitespace-nowrap pt-2 pb-0 scroll-smooth"
			></nav>
		</div>

		<!-- MAIN CONTENT: top padding removed (pt-0) as the sticky tab bar now provides necessary spacing -->
		<main class="container mx-auto p-4 md:p-8 pt-0">
			<div id="sectionsContainer" class="mt-6"></div>
		</main>

		<!-- Order Summary Modal -->
		<div
			id="orderModal"
			class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 p-4"
		>
			<div
				class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 p-6 max-w-xl w-full relative rounded-xl shadow-2xl transition-all duration-300 transform scale-95 opacity-0"
			>
				<button
					class="absolute top-4 right-4 text-xl text-gray-500 dark:text-gray-400 hover:text-red-500 transition"
					onclick="closeOrderSummary()"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-6 w-6"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M6 18L18 6M6 6l12 12"
						/>
					</svg>
				</button>
				<h2
					class="text-3xl font-bold mb-6 text-stone-600 dark:text-stone-400"
				>
					Order Summary
				</h2>
				<div
					id="orderContent"
					class="space-y-3 text-lg border-b pb-4 mb-4"
				></div>
				<div class="mt-4 flex justify-between text-2xl font-bold">
					<span>Total:</span>
					<span id="totalPrice">$0.00</span>
				</div>
			</div>
		</div>

		<script>
			let productsByCategory = {};
			let allProducts = [];
			let sections = [];
			let tabButtons = {}; // Store references to tab buttons
			let isScrolling = false; // Flag to prevent scroll event from triggering during programmatic scroll

			async function fetchProducts() {
				// Mock data for demonstration purposes, replace with actual fetch if available
				const mockData = [
					{
						id: 1,
						name: "Luxury Watch",
						price: 350.0,
						category: "Accessories",
						image: "https://placehold.co/400x400/8b5cf6/ffffff?text=Luxury+Watch",
					},
					{
						id: 2,
						name: "Silk Scarf",
						price: 55.0,
						category: "Accessories",
						image: "https://placehold.co/400x400/8b5cf6/ffffff?text=Silk+Scarf",
					},
					{
						id: 3,
						name: "Leather Wallet",
						price: 90.0,
						category: "Accessories",
						image: "https://placehold.co/400x400/8b5cf6/ffffff?text=Leather+Wallet",
					},
					{
						id: 4,
						name: "Espresso Maker",
						price: 199.0,
						category: "Home Goods",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Espresso+Maker",
					},
					{
						id: 5,
						name: "Weighted Blanket",
						price: 120.0,
						category: "Home Goods",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Weighted+Blanket",
					},
					{
						id: 6,
						name: "Crystal Vase",
						price: 75.0,
						category: "Home Goods",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Crystal+Vase",
					},
					{
						id: 7,
						name: "Designer Sunglasses",
						price: 180.0,
						category: "Fashion",
						image: "https://placehold.co/400x400/f59e0b/ffffff?text=Designer+Sunglasses",
					},
					{
						id: 8,
						name: "Leather Handbag",
						price: 250.0,
						category: "Fashion",
						image: "https://placehold.co/400x400/f59e0b/ffffff?text=Leather+Handbag",
					},
					{
						id: 9,
						name: "Silk Dress",
						price: 320.0,
						category: "Fashion",
						image: "https://placehold.co/400x400/f59e0b/ffffff?text=Silk+Dress",
					},
					{
						id: 10,
						name: "Ceramic Plate Set",
						price: 85.0,
						category: "Kitchen",
						image: "https://placehold.co/400x400/3b82f6/ffffff?text=Ceramic+Plate+Set",
					},
					{
						id: 11,
						name: "Chef's Knife",
						price: 120.0,
						category: "Kitchen",
						image: "https://placehold.co/400x400/3b82f6/ffffff?text=Chef's+Knife",
					},
					{
						id: 12,
						name: "Non-stick Pan Set",
						price: 150.0,
						category: "Kitchen",
						image: "https://placehold.co/400x400/3b82f6/ffffff?text=Non-stick+Pan+Set",
					},
					{
						id: 13,
						name: "Yoga Mat",
						price: 45.0,
						category: "Sports",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Yoga+Mat",
					},
					{
						id: 14,
						name: "Running Shoes",
						price: 130.0,
						category: "Sports",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Running+Shoes",
					},
					{
						id: 15,
						name: "Water Bottle",
						price: 25.0,
						category: "Sports",
						image: "https://placehold.co/400x400/10b981/ffffff?text=Water+Bottle",
					},
				];

				// Check if products.json exists or use mock data
				let data;
				try {
					const res = await fetch("./products.json");
					if (res.ok) {
						data = await res.json();
					} else {
						console.warn("products.json not found, using mock data.");
						data = mockData;
					}
				} catch (e) {
					console.error("Fetch failed, using mock data.", e);
					data = mockData;
				}

				data.forEach((p) =>
					(productsByCategory[p.category] ||= []).push(p)
				);
				sections = Object.keys(productsByCategory);
				allProducts = data;
				createTabs();
				createSections();
				loadProducts();
				updateCart(); // Load initial cart count
			}

			function createTabs() {
				const nav = document.getElementById("tabNav");
				// Added an 'All' tab
				const allBtn = createTabButton("All Products", () => {
					setActiveTab("All Products");
					window.scrollTo({ top: 0, behavior: "smooth" });
				});
				nav.appendChild(allBtn);
				tabButtons["All Products"] = allBtn;

				sections.forEach((sec) => {
					const btn = createTabButton(sec, () => {
						setActiveTab(sec);
						scrollToSection(sec);
					});
					nav.appendChild(btn);
					tabButtons[sec] = btn;
				});
			}

			function createTabButton(text, onClick) {
				const btn = document.createElement("button");
				btn.className =
					"text-xl font-semibold py-3 px-3 mx-1 relative text-gray-600 dark:text-gray-300 hover:text-stone-600 dark:hover:text-stone-400 transition duration-200 border-b-4 border-transparent hover:border-stone-600 dark:hover:border-stone-400 whitespace-nowrap";
				btn.textContent = text;
				btn.onclick = onClick;
				return btn;
			}

			function createSections() {
				const container = document.getElementById("sectionsContainer");
				sections.forEach((sec) => {
					const el = document.createElement("section");
					el.id = sec;
					el.className = "py-10 first:pt-0"; // Ensure sections are properly spaced
					el.innerHTML = `<h2 class='text-3xl font-bold mb-6 text-stone-600 dark:text-stone-400'>${sec}</h2><div id='${sec}Grid' class='grid gap-8 grid-cols-2 md:grid-cols-3 lg:grid-cols-4'></div>`;
					container.appendChild(el);
				});
			}

			function loadProducts() {
				sections.forEach((sec) => {
					const grid = document.getElementById(`${sec}Grid`);
					productsByCategory[sec].forEach((p) => {
						const card = document.createElement("div");
						// Increased padding and rounded corners, more subtle card background
						card.className =
							"p-5 flex flex-col bg-white dark:bg-gray-800 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300";
						card.innerHTML = `
                <!-- Removed shadow around the image -->
                <div class="h-48 flex items-center justify-center mb-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <img src="${
								p.image
							}" class="max-h-full max-w-full object-contain p-2" onerror="this.onerror=null;this.src='https://placehold.co/400x400/aaaaaa/000000?text=Image+Error';" alt="${
							p.name
						}">
                </div>
                <h3 class="text-xl font-semibold mb-1">${p.name}</h3>
                <p class="mb-3 text-lg font-bold text-stone-600 dark:text-stone-400">$${p.price.toFixed(
							2
						)}</p>
                <div class='flex items-center justify-between gap-3 mt-auto pt-3 border-t border-gray-100 dark:border-gray-700'>
                    <!-- Plus/Minus buttons color fixed to match scheme, with rounded shape -->
                    <button class='h-8 w-8 flex items-center justify-center text-2xl font-light rounded-full bg-stone-500 text-white hover:bg-stone-600 dark:bg-stone-400 dark:text-gray-900 dark:hover:bg-stone-300 transition shadow-md' onclick='changeQty(${
								p.id
							}, -1)'>-</button>
                    
                    <!-- Replaced input with a simple span and custom styling -->
                    <span id='qty-${
								p.id
							}' class='text-xl font-bold w-10 text-center select-none'>${parseInt(
							localStorage.getItem(`p_${p.id}`) || 0
						)}</span> 
                    
                    <button class='h-8 w-8 flex items-center justify-center text-2xl font-light rounded-full bg-stone-500 text-white hover:bg-stone-600 dark:bg-stone-400 dark:text-gray-900 dark:hover:bg-stone-300 transition shadow-md' onclick='changeQty(${
								p.id
							}, 1)'>+</button>
                </div>
            `;
						grid.appendChild(card);
					});
				});
			}

			// Function to dynamically set the sticky position of the tab bar
			function setStickyPositions() {
				const header = document.querySelector("header");
				const tabsWrapper = document.getElementById("sticky-tabs-wrapper");

				if (header && tabsWrapper) {
					// Set the 'top' style property for the tabs wrapper based on the header's actual height.
					// We subtract 1px to ensure a perfect, gap-free seal between the header and the tabs, fixing the visual gap.
					tabsWrapper.style.top = `${header.offsetHeight - 1}px`;
				}
			}

			// Function to scroll the tab navigation to bring a specific tab into view
			function scrollTabIntoView(tabName) {
				const tab = tabButtons[tabName];
				if (!tab) return;

				const tabNav = document.getElementById("tabNav");
				const tabRect = tab.getBoundingClientRect();
				const navRect = tabNav.getBoundingClientRect();

				// Calculate the position to scroll to
				// We want to center the tab in the visible area
				const tabCenter = tabRect.left - navRect.left + tabRect.width / 2;
				const navCenter = navRect.width / 2;
				const scrollPosition = tabNav.scrollLeft + tabCenter - navCenter;

				// Scroll to the calculated position with smooth behavior
				tabNav.scrollTo({
					left: scrollPosition,
					behavior: "smooth",
				});
			}

			// Function to set the active tab
			function setActiveTab(tabName) {
				// Remove active class from all tabs
				Object.values(tabButtons).forEach((btn) => {
					btn.classList.remove("tab-active");
				});

				// Add active class to the selected tab
				if (tabButtons[tabName]) {
					tabButtons[tabName].classList.add("tab-active");
					// Scroll the tab into view horizontally
					scrollTabIntoView(tabName);
				}
			}

			// Function to determine which section is currently in view
			function updateActiveTabOnScroll() {
				if (isScrolling) return; // Skip if we're in the middle of a programmatic scroll

				const header = document.querySelector("header");
				const tabsWrapper = document.getElementById("sticky-tabs-wrapper");
				const headerHeight = header.offsetHeight;
				const tabsHeight = tabsWrapper.offsetHeight;
				const totalOffset = headerHeight + tabsHeight;

				// Get current scroll position
				const scrollPosition = window.scrollY + totalOffset + 100; // Add 100px for better detection

				// Check if we're at the top of the page
				if (scrollPosition <= totalOffset + 100) {
					setActiveTab("All Products");
					return;
				}

				// Find which section is currently in view
				let currentSection = "";
				sections.forEach((sec) => {
					const section = document.getElementById(sec);
					if (section) {
						const sectionTop = section.offsetTop;
						const sectionBottom = sectionTop + section.offsetHeight;

						if (
							scrollPosition >= sectionTop &&
							scrollPosition < sectionBottom
						) {
							currentSection = sec;
						}
					}
				});

				if (currentSection) {
					setActiveTab(currentSection);
				}
			}

			// Renamed function to avoid conflict with window.scrollTo
			function scrollToSection(id) {
				const element = document.getElementById(id);
				const header = document.querySelector("header");
				const tabsWrapper = document.getElementById("sticky-tabs-wrapper");

				if (element && header && tabsWrapper) {
					// Set flag to prevent scroll event from triggering
					isScrolling = true;

					// Calculate the total height of the fixed elements (Header + Tab Bar)
					const headerHeight = header.offsetHeight;
					const tabsHeight = tabsWrapper.offsetHeight;
					const totalOffset = headerHeight + tabsHeight;

					// Get the element's position relative to the document
					const elementPosition =
						element.getBoundingClientRect().top + window.pageYOffset;

					// Calculate the final scroll position
					const offsetPosition = elementPosition - totalOffset;

					// Scroll to the calculated position
					window.scrollTo({
						top: offsetPosition,
						behavior: "smooth",
					});

					// Reset flag after scroll completes
					setTimeout(() => {
						isScrolling = false;
					}, 1000); // Give enough time for smooth scroll to complete
				} else {
					console.error(
						"Scroll failed: Missing target element or sticky elements."
					);
				}
			}

			function changeQty(id, delta) {
				let current = parseInt(localStorage.getItem(`p_${id}`) || 0);
				// Ensure quantity never goes below 0
				current = Math.max(0, current + delta);
				localStorage.setItem(`p_${id}`, current);

				// Update the span's text content
				const qtySpan = document.getElementById(`qty-${id}`);
				if (qtySpan) {
					qtySpan.textContent = current;
				}

				updateCart();
			}

			function updateCart() {
				let total = 0;
				allProducts.forEach(
					(p) =>
						(total += parseInt(localStorage.getItem(`p_${p.id}`) || 0))
				);
				document.getElementById("cartCount").textContent = total;
			}

			function showOrderSummary() {
				const modal = document.getElementById("orderModal");
				const modalContent = modal.querySelector("div");
				const content = document.getElementById("orderContent");
				let total = 0;
				let hasItems = false;
				content.innerHTML = "";

				allProducts.forEach((p) => {
					const qty = parseInt(localStorage.getItem(`p_${p.id}`) || 0);
					if (qty > 0) {
						hasItems = true;
						const subtotal = qty * p.price;
						total += subtotal;
						const div = document.createElement("div");
						div.className = "flex justify-between items-center";
						div.innerHTML = `
                            <span>${
											p.name
										} <span class="text-stone-500 dark:text-stone-300">x${qty}</span></span>
                            <span class="font-medium">$${subtotal.toFixed(
											2
										)}</span>
                        `;
						content.appendChild(div);
					}
				});

				if (!hasItems) {
					content.innerHTML =
						"<p class='text-center text-gray-500 dark:text-gray-400 italic'>Your order is currently empty.</p>";
				}

				document.getElementById(
					"totalPrice"
				).textContent = `$${total.toFixed(2)}`;

				// Show the modal with transition effect
				modal.classList.remove("hidden");
				setTimeout(() => {
					modalContent.classList.remove("scale-95", "opacity-0");
					modalContent.classList.add("scale-100", "opacity-100");
				}, 10);
			}

			function closeOrderSummary() {
				const modal = document.getElementById("orderModal");
				const modalContent = modal.querySelector("div");

				// Hide the modal with transition effect
				modalContent.classList.remove("scale-100", "opacity-100");
				modalContent.classList.add("scale-95", "opacity-0");

				setTimeout(() => {
					modal.classList.add("hidden");
				}, 300); // Match transition duration
			}

			document.addEventListener("DOMContentLoaded", () => {
				fetchProducts();
				// Set initial sticky positions after DOM is loaded
				setStickyPositions();

				// Set initial active tab
				setActiveTab("All Products");

				// Add scroll event listener to update active tab
				window.addEventListener("scroll", updateActiveTabOnScroll);
			});
			// Recalculate positions if the window size changes
			window.addEventListener("resize", setStickyPositions);
		</script>
	</body>
</html>
